xquery version "3.0";

declare namespace request="http://exist-db.org/xquery/request";

import module namespace loc = "http://ns.greenwood.thecodeyard.co.uk/location" at "/db/apps/greenwood/modules/location.xq";
declare option exist:serialize "method=xml media-type=text/xml omit-xml-declaration=no indent=yes";

let $request-id := string(request:get-parameter("id", ""))
return
    if ($request-id != "")
    then
        let $location := loc:get-location($request-id, true(), true(), true())
        return $location
                
	else 
    	<locations>
    		{
    			for $location in $loc:db/game/map/locations//descendant::*[@id]
    			let $location-id := concat($location/ancestor::game/@id, '-', $location/@id)
    			return loc:get-location($location-id, false(), false())
    		}
    	</locations>
 